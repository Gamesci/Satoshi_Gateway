<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satoshi Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body { background-color: #020617; color: #e2e8f0; }
        .card { background-color: #0f172a; border: 1px solid #1e293b; border-radius: 0.5rem; }
        .table-th { @apply px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase tracking-wider; }
        .table-td { @apply px-4 py-2 whitespace-nowrap text-sm text-slate-300 border-t border-slate-800; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const formatHashrate = (h) => {
            if (!h || h === 0) return '0 H/s';
            const k = 1000;
            const sizes = ['H/s', 'KH/s', 'MH/s', 'GH/s', 'TH/s', 'PH/s'];
            const i = Math.floor(Math.log(h) / Math.log(k));
            return parseFloat((h / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const formatDiff = (val) => {
            if (val === undefined || val === null) return '0';
            const units = ['', 'K', 'M', 'G', 'T', 'P', 'E'];
            let unitIndex = 0;
            let v = val;
            while (v >= 1000 && unitIndex < units.length - 1) {
                v /= 1000;
                unitIndex++;
            }
            // 500=500, 1000=1K, 1500=1.5K
            return parseFloat(v.toFixed(2)) + (unitIndex > 0 ? units[unitIndex] : '');
        };

        const formatTime = (ts) => {
            return new Date(ts * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        };

        const ChartComponent = ({ historyData }) => {
            const chartRef = useRef(null);
            
            useEffect(() => {
                if (!historyData) return;
                
                const options = {
                    chart: {
                        type: 'area',
                        height: 250,
                        toolbar: { show: false },
                        background: 'transparent',
                        animations: { enabled: false } 
                    },
                    theme: { mode: 'dark' },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: {
                        type: 'gradient',
                        gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.1, stops: [0, 90, 100] }
                    },
                    dataLabels: { enabled: false },
                    series: [{ name: 'Hashrate', data: historyData }],
                    xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { 
                        labels: { 
                            formatter: (val) => formatHashrate(val),
                            style: { colors: '#94a3b8' }
                        } 
                    },
                    grid: { borderColor: '#1e293b' },
                    colors: ['#3b82f6']
                };

                const chart = new ApexCharts(document.querySelector("#chart"), options);
                chart.render();
                chartRef.current = chart;

                return () => { chart.destroy(); };
            }, []);

            useEffect(() => {
                if (chartRef.current && historyData) {
                    chartRef.current.updateSeries([{ data: historyData }]);
                }
            }, [historyData]);

            return <div id="chart"></div>;
        };

        const Dashboard = () => {
            const [data, setData] = useState(null);
            const [activeTab, setActiveTab] = useState('workers');

            const fetchData = async () => {
                try {
                    const res = await fetch('/api/stats');
                    const json = await res.json();
                    setData(json);
                } catch (e) { console.error(e); }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 2000);
                return () => clearInterval(interval);
            }, []);

            if (!data) return <div className="min-h-screen flex items-center justify-center text-slate-500">Loading Gateway...</div>;

            const totalHashrate = data.workers.reduce((acc, w) => acc + w.hashrate, 0);
            const sortedShares = data.recent_shares ? [...data.recent_shares].sort((a, b) => b.time - a.time) : [];

            return (
                <div className="min-h-screen p-4 lg:p-8 max-w-[1600px] mx-auto font-sans">
                    {/* Top Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div className="card p-5 relative overflow-hidden group">
                            <div className="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2">
                                <svg className="w-24 h-24 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M13 7h-6l4 5-4 5h6l4-5-4-5z" /></svg>
                            </div>
                            <div className="text-sm text-slate-400 font-bold uppercase tracking-wider">Total Hashrate</div>
                            <div className="text-3xl font-bold text-white mt-1">{formatHashrate(totalHashrate)}</div>
                        </div>
                        <div className="card p-5">
                            <div className="text-sm text-slate-400 font-bold uppercase tracking-wider">Active Workers</div>
                            <div className="text-3xl font-bold text-green-400 mt-1">{data.workers.length}</div>
                        </div>
                        <div className="card p-5">
                            <div className="text-sm text-slate-400 font-bold uppercase tracking-wider">Block Height</div>
                            <div className="text-3xl font-bold text-yellow-400 mt-1">{data.block_info.height}</div>
                        </div>
                        <div className="card p-5">
                            <div className="text-sm text-slate-400 font-bold uppercase tracking-wider">Reward</div>
                            <div className="text-3xl font-bold text-slate-200 mt-1">
                                {(data.block_info.reward / 100000000).toFixed(4)} <span className="text-base text-slate-500">BTC</span>
                            </div>
                        </div>
                    </div>

                    {/* Chart Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div className="lg:col-span-2 card p-6">
                            <h3 className="text-slate-200 font-semibold mb-4">Hashrate (Last 60 mins)</h3>
                            <ChartComponent historyData={data.history} />
                        </div>
                        
                        {/* Block Info Detail & Best Share */}
                        <div className="card p-6">
                            <h3 className="text-slate-200 font-semibold mb-4">Network Info</h3>
                            <div className="space-y-4">
                                <div className="flex justify-between border-b border-slate-800 pb-2">
                                    <span className="text-slate-400">Network Diff</span>
                                    <span className="text-white font-mono">{formatDiff(data.block_info.net_diff)}</span>
                                </div>
                                <div className="flex justify-between border-b border-slate-800 pb-2">
                                    <span className="text-slate-400">Pool Algo</span>
                                    <span className="text-white">SHA-256</span>
                                </div>
                                
                                {/* Top 3 Best Shares */}
                                <div className="bg-blue-900/20 border border-blue-900/50 rounded p-3 mt-4">
                                    <div className="text-xs text-blue-400 font-bold mb-2 uppercase flex justify-between">
                                        <span>Top 3 Best Difficulty</span>
                                        <span className="text-[10px] opacity-70">SESSION</span>
                                    </div>
                                    
                                    {data.block_info.best_shares && data.block_info.best_shares.length > 0 ? (
                                        <div className="space-y-2">
                                            {data.block_info.best_shares.map((share, idx) => (
                                                <div key={idx} className="flex justify-between items-center text-sm border-b border-blue-800/30 last:border-0 pb-1 last:pb-0">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`font-mono text-xs w-4 h-4 flex items-center justify-center rounded ${idx===0 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-slate-700/50 text-slate-400'}`}>
                                                            {idx + 1}
                                                        </span>
                                                        <span className="text-slate-300 font-mono text-xs">{share.worker}</span>
                                                    </div>
                                                    <span className="text-white font-mono font-bold">
                                                        {formatDiff(share.diff)}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center text-slate-500 text-xs py-2">No shares yet</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Lists Area */}
                    <div className="card min-h-[400px]">
                        <div className="flex border-b border-slate-800">
                            <button 
                                onClick={() => setActiveTab('workers')}
                                className={`px-6 py-3 text-sm font-medium ${activeTab === 'workers' ? 'text-blue-400 border-b-2 border-blue-400' : 'text-slate-400 hover:text-white'}`}>
                                Active Workers
                            </button>
                            <button 
                                onClick={() => setActiveTab('shares')}
                                className={`px-6 py-3 text-sm font-medium ${activeTab === 'shares' ? 'text-blue-400 border-b-2 border-blue-400' : 'text-slate-400 hover:text-white'}`}>
                                Last Shares
                            </button>
                        </div>

                        <div className="p-0 overflow-x-auto">
                            {activeTab === 'workers' && (
                                <table className="w-full">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="table-th">Status</th>
                                            <th className="table-th">ID (ExtraNonce1)</th>
                                            <th className="table-th text-right">Hashrate</th>
                                            <th className="table-th text-right">Difficulty</th>
                                            <th className="table-th text-right">Shares</th>
                                            <th className="table-th text-right">Last Seen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.workers.map(w => (
                                            <tr key={w.id} className="hover:bg-slate-800/50 transition">
                                                <td className="table-td">
                                                    <div className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] mx-auto lg:mx-0"></div>
                                                </td>
                                                <td className="table-td font-mono text-blue-400">{w.ex1}</td>
                                                <td className="table-td text-right text-white font-bold">{formatHashrate(w.hashrate)}</td>
                                                <td className="table-td text-right font-mono">{formatDiff(w.diff)}</td>
                                                <td className="table-td text-right">{w.shares}</td>
                                                <td className="table-td text-right text-slate-500">{formatTime(w.last_seen)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}

                            {activeTab === 'shares' && (
                                <table className="w-full">
                                    <thead className="bg-slate-900/50">
                                        <tr>
                                            <th className="table-th">Time</th>
                                            <th className="table-th">Worker</th>
                                            <th className="table-th text-right">Share Diff</th>
                                            <th className="table-th text-right">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortedShares.map((s, idx) => (
                                            <tr key={idx} className={`hover:bg-slate-800/50 transition ${s.is_block ? 'bg-yellow-900/20' : ''}`}>
                                                <td className="table-td text-slate-400">{formatTime(s.time)}</td>
                                                <td className="table-td font-mono text-blue-400">{s.worker}</td>
                                                <td className="table-td text-right font-mono text-white">
                                                    {formatDiff(s.diff)}
                                                </td>
                                                <td className="table-td text-right">
                                                    {s.is_block ? (
                                                        <span className="text-yellow-400 font-bold px-2 py-0.5 rounded bg-yellow-400/10">BLOCK FOUND</span>
                                                    ) : (
                                                        <span className="text-green-500 text-xs">Valid</span>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
